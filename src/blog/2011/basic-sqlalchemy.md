tags: python, programming, sql, db
title:  SQLAlchemy: как втянуться
date: 2011-04-22
----

SQLAlchemy сейчас - очевидный лидер ORM в питоне, но у неë есть один
довольно неприятный недостаток: чтобы начать пользоваться, приходится
прочитать немало документации. Поэтому я решил написать (очень) короткий
пост-введение в алхимию.

Уровень 1: SQL руками
---------------------

Первым делом нам нужно соединение к базе, с которым можно что-то делать:

Если хочется именованных параметров, можно использовать `text()`:

Из объектов, которые получаются итерацией результата - `RowProxy` -
данные можно вытаскивать и индексом, и ключом, и атрибутом:

Нужна транзакция?

Это уже что-то и так можно жить, тем более что оно экранирует параметры
автоматически.

Уровень 2: SQL-выражения в питоне
---------------------------------

Можно получить объект таблицы из базы (с автоопределением колонок) и
работать с ним, если так будет удобнее:

Т.е. абсолютно идентичный запрос, но уже в питоне.

Уровень 3: ORM
--------------

Ну и если приятнее с объектами работать, которым можно поведение
задавать:

Тут уже можно использовать ORM по полной:

Еще, если использовать `Session.execute()`, то можно сразу передавать
именованные параметры:

Разное
------

Нужно сказать, что по умолчанию у `Engine` уже есть пул соединений, что
приятно.

Метаданные с рефлексией и ранним биндингом - не совсем принятый подход,
это только для маленьких наколенных скриптов и работы в шелле, скорее, а
так обычно `Engine` к `MetaData` добавляют где-то отдельно, в чтении
настроек, когда уже все таблицы определены (через `meta.bind = e`).

Сессия часто напрямик не используется, особенно в многопоточных
приложениях -есть \`orm.scoped\_session\`\_, который создаëт
тред-локальную сессию.

Вот в принципе и всë, дальше есть
[документация](http://www.sqlalchemy.org/docs/). :)
